---
tags: development os.x
---
I am currently working on a [[Ruby]] extension written in [[C]] which uses an [[ANTLR]]-generated [[parser]] and must therefore link against the [[C target]] runtime library.

By default, when you build and install the C target runtime the following items are installed:

* <tt>/usr/local/lib/libantlr3c.dylib</tt>
* <tt>/usr/local/lib/libantlr3c.la</tt>
* <tt>/usr/local/lib/libantlr3c.a</tt>

It appears that the [[Mac OS X]] linker is hard-wired to search dynamic libraries before static ones, so when build my [[Ruby]] extension I found that the dynamic library was used. The linker invocation (as generated by [[mkmf]] was as follows:

<pre>cc -dynamic -bundle -undefined suppress -flat_namespace  -L"/usr/local/lib" \
  -o walrus_parser.bundle walrus_parser.o WalrusLexer.o WalrusParser.o  \
  -lantlr3c  -lpthread -ldl -lobjc</pre>

And [[otool]] (<tt>otool -L walrus_parser.bundle</tt>) indicates that the followed shared libraries were used:

<pre>walrus_parser.bundle:
        /usr/local/lib/libantlr3c.dylib (compatibility version 0.0.0, current version 0.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 88.5.1)
        /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 227.0.0)</pre>

Note that you cannot pass a file extension to the <tt>-l</tt> switch (<tt>-lantlr3c.a</tt>) to force the static library to be used. One way to force the static library to be used is to simply remove the dynamic version. A less destructive way is [http://lists.apple.com/archives/fortran-dev/2005/Jan/msg00004.html recommended here].

Basically, the idea is:

# Create symlink <tt>libname_s.a</tt> which points to the static lib <tt>libname.a</tt>.
# Tell the compiler to link against <tt>libname_s</tt> (ie. <tt>-lname_s</tt>).
# Depending on where you create the symlink, may be necessary to add a <tt>-L</tt> switch so linker knows where to find it (for example, if you don't have the administrator privileges necessary to write to <tt>/usr/local/</tt> or don't wish to modify that directory).
